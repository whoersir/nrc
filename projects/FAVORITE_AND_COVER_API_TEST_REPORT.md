# æ”¶è—å’Œå°é¢ API æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¶é—´**ï¼š2026-01-31 05:20
**æµ‹è¯•ç¯å¢ƒ**ï¼šLocalhost, Next.js 16.1.1, Supabase

---

## ğŸ“‹ æµ‹è¯•æ¦‚è§ˆ

| API | æµ‹è¯•é¡¹ | ç»“æœ |
|-----|--------|------|
| **æ”¶è— API** | æ·»åŠ æ”¶è— | âœ… é€šè¿‡ |
| **æ”¶è— API** | è·å–æ”¶è—åˆ—è¡¨ | âœ… é€šè¿‡ |
| **æ”¶è— API** | å–æ¶ˆæ”¶è— | âœ… é€šè¿‡ |
| **å°é¢ API** | çœŸå®å°é¢å›¾ç‰‡ | âœ… é€šè¿‡ |
| **å°é¢ API** | å ä½å›¾ï¼ˆSVGï¼‰ | âœ… é€šè¿‡ |

---

## ğŸ¯ æ”¶è— API æµ‹è¯•è¯¦æƒ…

### 1. æ·»åŠ æ”¶è—

**è¯·æ±‚**ï¼š
```bash
curl -X POST "http://localhost:5000/api/favorites" \
  -H "Content-Type: application/json" \
  -d '{"trackId": "track_6412cc2d"}'
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "æ”¶è—æˆåŠŸ"
}
```

**çŠ¶æ€**ï¼šâœ… é€šè¿‡

---

### 2. è·å–æ”¶è—åˆ—è¡¨

**è¯·æ±‚**ï¼š
```bash
curl "http://localhost:5000/api/favorites"
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "data": [
    {
      "id": "track_6412cc2d",
      "filename": "123æœ¨å¤´äºº.wav",
      "title": "01. 123æœ¨å¤´äºº.wav",
      "title_pinyin": "01.123mutouren.wav",
      "title_first_letter": "#",
      "artist": "é»‘Girl",
      "artist_pinyin": "heigirl",
      "artist_first_letter": "H",
      "album": null,
      "duration": null,
      "file_size": 41769368,
      "format": "wav",
      "added_at": "2026-01-31T05:07:29.117",
      "favoritedAt": "2026-01-31T05:19:50.55"
    }
  ],
  "total": 1
}
```

**çŠ¶æ€**ï¼šâœ… é€šè¿‡

---

### 3. å–æ¶ˆæ”¶è—

**è¯·æ±‚**ï¼š
```bash
curl -X DELETE "http://localhost:5000/api/favorites/track_6412cc2d"
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "å–æ¶ˆæ”¶è—æˆåŠŸ"
}
```

**çŠ¶æ€**ï¼šâœ… é€šè¿‡

---

## ğŸ–¼ï¸ æ­Œæ‰‹å°é¢ API æµ‹è¯•è¯¦æƒ…

### 1. çœŸå®å°é¢å›¾ç‰‡

**è¯·æ±‚**ï¼š
```bash
curl -I "http://localhost:5000/api/music/cover/%E5%91%A8%E6%9D%B0%E4%BC%A6"
```

**å“åº”**ï¼š
```
HTTP/1.1 200 OK
content-type: image/jpeg
Cache-Control: public, max-age=86400
```

**è¯´æ˜**ï¼šå¦‚æœ `F:\Music\å‘¨æ°ä¼¦\cover.jpg` å­˜åœ¨ï¼Œè¿”å›çœŸå®çš„ JPEG å›¾ç‰‡

**çŠ¶æ€**ï¼šâœ… é€šè¿‡

---

### 2. å ä½å›¾ï¼ˆSVGï¼‰

**è¯·æ±‚**ï¼š
```bash
curl -I "http://localhost:5000/api/music/cover/NonExistArtist"
```

**å“åº”**ï¼š
```
HTTP/1.1 200 OK
content-type: image/svg+xml
Cache-Control: public, max-age=86400
```

**è¯´æ˜**ï¼šå¦‚æœå°é¢ä¸å­˜åœ¨ï¼Œè¿”å› SVG æ ¼å¼çš„å ä½å›¾ï¼Œæ˜¾ç¤ºæ­Œæ‰‹é¦–å­—æ¯

**çŠ¶æ€**ï¼šâœ… é€šè¿‡

---

## ğŸ› ä¿®å¤çš„é—®é¢˜

### é—®é¢˜ 1ï¼šNext.js 15+ å¼‚æ­¥ params

**æè¿°**ï¼šåœ¨ `/api/favorites/[id]/route.ts` ä¸­ï¼Œ`params.id` ä¸º `undefined`

**åŸå› **ï¼šNext.js 15+ å°†åŠ¨æ€è·¯ç”±å‚æ•°æ”¹ä¸ºå¼‚æ­¥ï¼ˆPromiseï¼‰

**æ—¥å¿—è¯æ®**ï¼š
```
DELETE | 204 | ... | ...track_id=eq.undefined
```

**ä¿®å¤**ï¼š
```typescript
// ä¿®å¤å‰
const trackId = params.id;

// ä¿®å¤å
const { id: trackId } = await params;
```

**æ–‡ä»¶**ï¼š`app/api/favorites/[id]/route.ts`

**çŠ¶æ€**ï¼šâœ… å·²ä¿®å¤

---

### é—®é¢˜ 2ï¼šæœåŠ¡ç«¯è®¤è¯

**æè¿°**ï¼šAPI è·¯ç”±ä¸­ä½¿ç”¨äº†å®¢æˆ·ç«¯çš„ `getCurrentUser()`ï¼Œå¯¼è‡´æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯

**åŸå› **ï¼šå®¢æˆ·ç«¯æ–¹æ³•ä½¿ç”¨ `localStorage`ï¼Œåœ¨æœåŠ¡ç«¯æ— æ³•è®¿é—®

**ä¿®å¤**ï¼š
1. åˆ›å»º `src/lib/server-auth.ts` - æœåŠ¡ç«¯è®¤è¯å·¥å…·
2. æ”¯æŒé»˜è®¤ç”¨æˆ·ï¼ˆ`local_user`ï¼‰
3. æ”¯æŒä» Cookie è·å–ç”¨æˆ·ä¿¡æ¯

**æ–‡ä»¶**ï¼š`src/lib/server-auth.ts`, `app/api/favorites/route.ts`, `app/api/favorites/[id]/route.ts`

**çŠ¶æ€**ï¼šâœ… å·²ä¿®å¤

---

### é—®é¢˜ 3ï¼šå°é¢ API è¿”å› 404

**æè¿°**ï¼šæ­Œæ‰‹å°é¢ä¸å­˜åœ¨æ—¶è¿”å› 404 é”™è¯¯

**å½±å“**ï¼šå‰ç«¯æ— æ³•æ˜¾ç¤ºå ä½å›¾

**ä¿®å¤**ï¼š
1. æ£€æŸ¥å°é¢æ–‡ä»¶æ˜¯å¦å­˜åœ¨
2. å¦‚æœä¸å­˜åœ¨ï¼Œè¿”å› SVG å ä½å›¾ï¼ˆæ˜¾ç¤ºæ­Œæ‰‹é¦–å­—æ¯ï¼‰
3. æ·»åŠ  1 å¤©ç¼“å­˜æ§åˆ¶

**æ–‡ä»¶**ï¼š`app/api/music/cover/[artist]/route.ts`

**çŠ¶æ€**ï¼šâœ… å·²ä¿®å¤

---

## ğŸ“Š æµ‹è¯•æ€»ç»“

### âœ… é€šè¿‡çš„åŠŸèƒ½

1. **æ”¶è—ç®¡ç†**
   - âœ… æ·»åŠ æ”¶è—
   - âœ… è·å–æ”¶è—åˆ—è¡¨
   - âœ… å–æ¶ˆæ”¶è—
   - âœ… æ•°æ®æŒä¹…åŒ–ï¼ˆSupabaseï¼‰
   - âœ… æœåŠ¡ç«¯è®¤è¯

2. **æ­Œæ‰‹å°é¢**
   - âœ… çœŸå®å°é¢å›¾ç‰‡æ”¯æŒ
   - âœ… SVG å ä½å›¾æ”¯æŒ
   - âœ… ç¼“å­˜æ§åˆ¶ï¼ˆ1 å¤©ï¼‰
   - âœ… Next.js 15+ å¼‚æ­¥ params å…¼å®¹

### ğŸ”§ æŠ€æœ¯äº®ç‚¹

1. **æœåŠ¡ç«¯è®¤è¯**ï¼šåˆ›å»ºäº†ç‹¬ç«‹çš„æœåŠ¡ç«¯è®¤è¯å·¥å…·ï¼Œæ”¯æŒé»˜è®¤ç”¨æˆ·å’Œ Cookie è®¤è¯
2. **å ä½å›¾ç”Ÿæˆ**ï¼šåŠ¨æ€ç”Ÿæˆ SVG å ä½å›¾ï¼Œæ˜¾ç¤ºæ­Œæ‰‹é¦–å­—æ¯
3. **Next.js 15+ å…¼å®¹**ï¼šæ­£ç¡®å¤„ç†å¼‚æ­¥ params

### ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å­˜æ§åˆ¶**ï¼šå°é¢ API è®¾ç½® 1 å¤©ç¼“å­˜
2. **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**ï¼šæ”¶è—åˆ—è¡¨ä½¿ç”¨ `in()` æŸ¥è¯¢ä¸€æ¬¡æ€§è·å–æ‰€æœ‰æ­Œæ›²è¯¦æƒ…
3. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

---

## ğŸ‰ ç»“è®º

æ‰€æœ‰ API æµ‹è¯•é€šè¿‡ï¼æ”¶è—å’Œå°é¢åŠŸèƒ½å·²ç»å®Œå…¨å¯ç”¨ã€‚

### ä¸‹ä¸€æ­¥

1. **é‡å¯å¼€å‘æœåŠ¡å™¨**ï¼šè§£å†³ TypeScript è·¯å¾„åˆ«åç¼–è¯‘é—®é¢˜
2. **æµ‹è¯•å‰ç«¯ UI**ï¼šéªŒè¯æ’­æ”¾å™¨é¡µé¢çš„æ”¶è—åŠŸèƒ½
3. **ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ**ï¼šæ·»åŠ åŠ è½½çŠ¶æ€ã€é”™è¯¯æç¤ºç­‰

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2026-01-31 05:20
