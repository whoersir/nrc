# Titleæ•°æ®ä¼˜åŒ–æ–¹æ¡ˆå®æ–½æŒ‡å—

## ğŸ“‹ ä¼˜åŒ–æ–¹æ¡ˆæ¦‚è¿°

æœ¬æ–¹æ¡ˆæŒ‰ç…§é«˜ä¸­ä½ä¼˜å…ˆçº§ä¾æ¬¡å®æ–½,å…¨é¢ä¼˜åŒ–æ•°æ®åº“ä¸­çš„titleæ•°æ®è´¨é‡,æå‡æœç´¢å’Œæ’åºä½“éªŒã€‚

---

## ğŸš€ é«˜ä¼˜å…ˆçº§: Titleæ¸…ç†åŠŸèƒ½ (å·²å®æ–½)

### å®æ–½å†…å®¹

1. **åˆ›å»ºTitleCleanerç±»** (`src/lib/music/file-scanner.ts`)
   - `clean(title)` - æ¸…ç†æ­Œæ›²æ ‡é¢˜
   - `cleanArtist(artist)` - æ¸…ç†æ­Œæ‰‹åç§°

2. **æ¸…ç†è§„åˆ™**
   - å»é™¤æ–‡ä»¶æ‰©å±•å (.mp3, .wav, .flacç­‰)
   - å»é™¤æ•°å­—å‰ç¼€ (å¦‚ "01. æ­Œæ›²å" -> "æ­Œæ›²å")
   - å»é™¤ç‰ˆæœ¬ä¿¡æ¯ (Live, Acoustic, Remixç­‰, å¯é…ç½®ä¿ç•™)
   - æ ‡å‡†åŒ–å¼•å· (ã€Œã€ã€ã€ -> " ")
   - æ¸…ç†å¤šä½™ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦

3. **é›†æˆåˆ°æ‰«ææµç¨‹**
   - åœ¨M3Uæ–‡ä»¶è§£ææ—¶è‡ªåŠ¨æ¸…ç†title
   - åœ¨æ–‡ä»¶åæå–æ—¶è‡ªåŠ¨æ¸…ç†title
   - åœ¨æ‰«æç»“æœä¸­è¾“å‡ºæ¸…ç†åçš„title

### ä½¿ç”¨æ–¹å¼

æ‰«æéŸ³ä¹åº“æ—¶ä¼šè‡ªåŠ¨åº”ç”¨titleæ¸…ç†,æ— éœ€é¢å¤–æ“ä½œ:

```bash
# ä½¿ç”¨ç°æœ‰çš„æ‰«æAPI
POST /api/music/scan
{
  "force": false,
  "extractMetadata": false,
  "verbose": true
}
```

---

## ğŸ”§ ä¸­ä¼˜å…ˆçº§: æ‰¹é‡æ›´æ–°API (å·²å®æ–½)

### å®æ–½å†…å®¹

1. **æ‰¹é‡æ¸…ç†å’Œæ›´æ–°API** (`/api/music/tracks/batch-update`)
   - æ”¯æŒé¢„æ¼”æ¨¡å¼ (dryRun) - æŸ¥çœ‹å°†è¦æ›´æ–°çš„æ•°æ®ä½†ä¸å®é™…æ›´æ–°
   - æ”¯æŒé™åˆ¶å¤„ç†æ•°é‡ (limit)
   - è‡ªåŠ¨æ¸…ç†titleå¹¶æ›´æ–°ç›¸å…³å­—æ®µ

2. **æ‰‹åŠ¨æ›´æ–°API** (`/api/music/tracks/[id]/update-title`)
   - æ”¯æŒæ‰‹åŠ¨ç¼–è¾‘å•é¦–æ­Œæ›²çš„title
   - è‡ªåŠ¨åº”ç”¨æ¸…ç†è§„åˆ™

3. **MusicServiceæ–°å¢æ–¹æ³•**
   - `batchUpdateTitles()` - æ‰¹é‡æ›´æ–°title
   - `updateTrackTitle()` - æ›´æ–°å•é¦–æ­Œæ›²title

### APIä½¿ç”¨ç¤ºä¾‹

#### 1. æ‰¹é‡æ¸…ç†æ‰€æœ‰æ­Œæ›² (é¢„æ¼”æ¨¡å¼)

```bash
POST /api/music/tracks/batch-update
{
  "dryRun": true
}
```

å“åº”ç¤ºä¾‹:
```json
{
  "success": true,
  "message": "é¢„æ¼”å®Œæˆ: å…±å¤„ç† 100 é¦–æ­Œæ›²,å…¶ä¸­ 25 é¦–éœ€è¦æ›´æ–°",
  "data": {
    "processedCount": 100,
    "updatedCount": 25,
    "unchangedCount": 75,
    "details": [
      {
        "id": "track_xxx",
        "originalTitle": "01. æˆ‘çš„ä¸­å›½å¿ƒ.mp3",
        "newTitle": "æˆ‘çš„ä¸­å›½å¿ƒ",
        "changed": true
      }
    ]
  }
}
```

#### 2. å®é™…æ‰§è¡Œæ‰¹é‡æ›´æ–°

```bash
POST /api/music/tracks/batch-update
{
  "dryRun": false
}
```

#### 3. é™åˆ¶å¤„ç†æ•°é‡

```bash
POST /api/music/tracks/batch-update
{
  "limit": 10,
  "dryRun": false
}
```

#### 4. æ‰‹åŠ¨æ›´æ–°å•é¦–æ­Œæ›²

```bash
PUT /api/music/tracks/[id]/update-title
{
  "title": "æ–°æ ‡é¢˜"
}
```

---

## ğŸ“Š ä½ä¼˜å…ˆçº§: æ•°æ®åº“Schemaä¼˜åŒ– (å·²å®æ–½)

### å®æ–½å†…å®¹

1. **æ–°å¢è§„èŒƒåŒ–å­—æ®µ**
   - `title_clean` - æ¸…ç†åçš„æ ‡é¢˜ (å»é™¤åºå·ã€æ‰©å±•åç­‰)
   - `title_normalized` - æ ‡å‡†åŒ–æ ‡é¢˜ (å…¨å°å†™ã€å»ç‰¹æ®Šå­—ç¬¦,ä¾¿äºæœç´¢)
   - `artist_clean` - æ¸…ç†åçš„æ­Œæ‰‹å
   - `artist_normalized` - æ ‡å‡†åŒ–æ­Œæ‰‹å

2. **æ–°å¢ç´¢å¼•**
   - `idx_title_clean` - ä¼˜åŒ–æ¸…ç†åtitleçš„æœç´¢
   - `idx_title_normalized` - ä¼˜åŒ–æ ‡å‡†åŒ–titleçš„æœç´¢
   - `idx_artist_clean` - ä¼˜åŒ–æ¸…ç†åartistçš„æœç´¢
   - `idx_artist_normalized` - ä¼˜åŒ–æ ‡å‡†åŒ–artistçš„æœç´¢

### æ•°æ®åº“è¿ç§»æ­¥éª¤

#### æ–¹å¼1: åœ¨Supabaseæ§åˆ¶å°æ‰§è¡Œ

1. æ‰“å¼€Supabaseæ§åˆ¶å°çš„SQLç¼–è¾‘å™¨
2. æ‰§è¡Œè¿ç§»è„šæœ¬: `db/migrations/001_add_title_clean_fields.sql`
3. ç­‰å¾…è¿ç§»å®Œæˆ

#### æ–¹å¼2: ä½¿ç”¨Supabase CLI (å¦‚æœå·²é…ç½®)

```bash
# åˆ›å»ºè¿ç§»æ–‡ä»¶
supabase migration new add_title_clean_fields

# å°†SQLå†…å®¹å¤åˆ¶åˆ°è¿ç§»æ–‡ä»¶ä¸­

# åº”ç”¨è¿ç§»
supabase db push
```

### è‡ªåŠ¨å¡«å……è§„èŒƒåŒ–å­—æ®µ

è°ƒç”¨æ‰¹é‡æ›´æ–°APIæ—¶,ä¼šè‡ªåŠ¨å¡«å……è¿™äº›æ–°å­—æ®µ:

```bash
POST /api/music/tracks/batch-update
{
  "dryRun": false
}
```

---

## âœ… å®æ–½æ£€æŸ¥æ¸…å•

- [x] é«˜ä¼˜å…ˆçº§: Titleæ¸…ç†å‡½æ•°å·²æ·»åŠ 
- [x] é«˜ä¼˜å…ˆçº§: æ‰«ææµç¨‹å·²é›†æˆæ¸…ç†åŠŸèƒ½
- [x] ä¸­ä¼˜å…ˆçº§: æ‰¹é‡æ›´æ–°APIå·²åˆ›å»º
- [x] ä¸­ä¼˜å…ˆçº§: æ‰‹åŠ¨æ›´æ–°APIå·²åˆ›å»º
- [x] ä½ä¼˜å…ˆçº§: æ•°æ®åº“è¿ç§»è„šæœ¬å·²åˆ›å»º
- [x] ä½ä¼˜å…ˆçº§: MusicServiceå·²é€‚é…æ–°å­—æ®µ
- [ ] æ•°æ®åº“è¿ç§»å·²åº”ç”¨ (éœ€è¦ç”¨æˆ·æ‰‹åŠ¨æ‰§è¡Œ)
- [ ] ç°æœ‰æ•°æ®å·²æ‰¹é‡æ›´æ–° (éœ€è¦ç”¨æˆ·æ‰‹åŠ¨æ‰§è¡ŒAPI)

---

## ğŸ¯ å»ºè®®çš„æ‰§è¡Œæµç¨‹

1. **æµ‹è¯•æ¸…ç†åŠŸèƒ½** (å¯é€‰)
   ```bash
   # åœ¨å°èŒƒå›´å†…æµ‹è¯•
   POST /api/music/tracks/batch-update
   {
     "limit": 10,
     "dryRun": true
   }
   ```

2. **é¢„è§ˆæ‰€æœ‰éœ€è¦æ›´æ–°çš„æ•°æ®**
   ```bash
   POST /api/music/tracks/batch-update
   {
     "dryRun": true
   }
   ```

3. **åº”ç”¨æ•°æ®åº“è¿ç§»**
   - åœ¨Supabaseæ§åˆ¶å°æ‰§è¡Œ `db/migrations/001_add_title_clean_fields.sql`

4. **æ‰§è¡Œæ‰¹é‡æ›´æ–°**
   ```bash
   POST /api/music/tracks/batch-update
   {
     "dryRun": false
   }
   ```

5. **éªŒè¯ç»“æœ**
   - æ£€æŸ¥titleæ˜¯å¦æ¸…ç†å¹²å‡€
   - æµ‹è¯•æœç´¢åŠŸèƒ½æ˜¯å¦æ­£å¸¸
   - ç¡®è®¤æ’åºåŠŸèƒ½æ˜¯å¦æ­£å¸¸

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **æ‹¼éŸ³å‡†ç¡®æ€§æå‡**
   - è€ƒè™‘ä½¿ç”¨ `pinyin-pro` æ›¿ä»£å½“å‰çš„æ‹¼éŸ³åº“
   - å¤šéŸ³å­—å¤„ç†ä¼˜åŒ–

2. **æ™ºèƒ½å»é‡**
   - åŸºäºtitle_normalizedå­—æ®µæ£€æµ‹é‡å¤æ­Œæ›²
   - æç¤ºç”¨æˆ·åˆå¹¶æˆ–åˆ é™¤é‡å¤é¡¹

3. **æ‰¹é‡ç¼–è¾‘åŠŸèƒ½**
   - æ”¯æŒæ‰¹é‡é€‰æ‹©æ­Œæ›²
   - æ”¯æŒæ‰¹é‡ä¿®æ”¹artist
   - æ”¯æŒæ‰¹é‡æ·»åŠ æ ‡ç­¾

4. **æœç´¢ä¼˜åŒ–**
   - ä½¿ç”¨title_normalizedå­—æ®µè¿›è¡Œæ¨¡ç³Šæœç´¢
   - å®ç°å…¨æ–‡æœç´¢
   - æ·»åŠ æœç´¢å»ºè®®åŠŸèƒ½

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: æ‰¹é‡æ›´æ–°ä¼šè¦†ç›–æ‰‹åŠ¨ç¼–è¾‘çš„titleå—?

A: ä¸ä¼šã€‚æ‰¹é‡æ›´æ–°åªä¼šæ›´æ–°title,å¦‚æœtitleå·²ç»å¾ˆå¹²å‡€(ä¸éœ€è¦æ¸…ç†),å°±ä¸ä¼šä¿®æ”¹ã€‚

### Q2: é¢„æ¼”æ¨¡å¼ä¸‹èƒ½æŸ¥çœ‹å“ªäº›æ•°æ®ä¼šå˜åŒ–å—?

A: å¯ä»¥ã€‚å“åº”ä¸­çš„ `details` å­—æ®µä¼šåˆ—å‡ºæ‰€æœ‰å°†è¦æ›´æ–°çš„è®°å½•,åŒ…æ‹¬ `originalTitle` å’Œ `newTitle` çš„å¯¹æ¯”ã€‚

### Q3: å¦‚æœæ¸…ç†åçš„titleä¸å¯¹æ€ä¹ˆåŠ?

A: å¯ä»¥ä½¿ç”¨æ‰‹åŠ¨æ›´æ–°API (`/api/music/tracks/[id]/update-title`) ä¿®æ­£å•é¦–æ­Œæ›²çš„titleã€‚

### Q4: æ•°æ®åº“è¿ç§»ä¼šå½±å“ç°æœ‰æ•°æ®å—?

A: ä¸ä¼šã€‚è¿ç§»åªæ˜¯æ·»åŠ æ–°å­—æ®µ,ä¸ä¼šä¿®æ”¹æˆ–åˆ é™¤ç°æœ‰æ•°æ®ã€‚æ–°å­—æ®µé»˜è®¤ä¸ºNULLã€‚

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `src/lib/music/file-scanner.ts` - TitleCleanerç±»å®šä¹‰
- `src/lib/music/music-service.ts` - MusicServiceæ‰©å±•æ–¹æ³•
- `app/api/music/tracks/batch-update/route.ts` - æ‰¹é‡æ›´æ–°API
- `app/api/music/tracks/[id]/update-title/route.ts` - æ‰‹åŠ¨æ›´æ–°API
- `db/migrations/001_add_title_clean_fields.sql` - æ•°æ®åº“è¿ç§»è„šæœ¬
